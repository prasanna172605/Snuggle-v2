{
    "database": {
        "rules": {
            ".read": false,
            ".write": false,
            "users": {
                "$userId": {
                    ".read": "auth != null",
                    ".write": "auth != null && auth.uid === $userId",
                    ".validate": "newData.hasChildren(['id', 'username', 'email']) && newData.child('id').val() === $userId",
                    "id": {
                        ".validate": "newData.isString() && newData.val() === $userId"
                    },
                    "username": {
                        ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 20 && newData.val().matches(/^[a-zA-Z0-9_-]+$/)"
                    },
                    "email": {
                        ".validate": "newData.isString() && newData.val().matches(/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/)"
                    },
                    "fullName": {
                        ".validate": "newData.isString() && newData.val().length <= 100"
                    },
                    "bio": {
                        ".validate": "newData.isString() && newData.val().length <= 500"
                    },
                    "avatar": {
                        ".validate": "newData.isString()"
                    },
                    "createdAt": {
                        ".validate": "newData.isNumber()"
                    },
                    "$other": {
                        ".validate": false
                    }
                }
            },
            "chats": {
                ".indexOn": [
                    "lastMessageTimestamp"
                ],
                "$chatId": {
                    ".read": "auth != null && (data.child('participants').child(auth.uid).exists() || root.child('chats/' + $chatId + '/participants/' + auth.uid).exists())",
                    ".write": "auth != null && (data.child('participants').child(auth.uid).exists() || newData.child('participants').child(auth.uid).exists())",
                    "participants": {
                        "$userId": {
                            ".validate": "newData.isBoolean()"
                        }
                    },
                    "lastMessage": {
                        ".validate": "newData.isString() && newData.val().length <= 200"
                    },
                    "lastMessageTimestamp": {
                        ".validate": "newData.isNumber()"
                    },
                    "createdAt": {
                        ".validate": "newData.isNumber()"
                    },
                    "$other": {
                        ".validate": false
                    }
                }
            },
            "messages": {
                ".indexOn": [
                    "timestamp"
                ],
                "$chatId": {
                    ".read": "auth != null && root.child('chats/' + $chatId + '/participants/' + auth.uid).exists()",
                    "$messageId": {
                        ".write": "auth != null && root.child('chats/' + $chatId + '/participants/' + auth.uid).exists() && (!data.exists() || data.child('senderId').val() === auth.uid)",
                        ".validate": "newData.hasChildren(['id', 'senderId', 'text', 'timestamp'])",
                        "id": {
                            ".validate": "newData.isString()"
                        },
                        "senderId": {
                            ".validate": "newData.isString() && newData.val() === auth.uid"
                        },
                        "text": {
                            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 5000"
                        },
                        "timestamp": {
                            ".validate": "newData.isNumber() && newData.val() <= now"
                        },
                        "imageUrl": {
                            ".validate": "newData.isString()"
                        },
                        "readBy": {
                            "$userId": {
                                ".validate": "newData.isBoolean()"
                            }
                        },
                        "$other": {
                            ".validate": false
                        }
                    }
                }
            },
            "typing": {
                "$chatId": {
                    ".read": "auth != null && root.child('chats/' + $chatId + '/participants/' + auth.uid).exists()",
                    "$userId": {
                        ".write": "auth != null && $userId === auth.uid && root.child('chats/' + $chatId + '/participants/' + auth.uid).exists()",
                        ".validate": "newData.isBoolean()"
                    }
                }
            },
            "presence": {
                "$userId": {
                    ".read": "auth != null",
                    ".write": "auth != null && $userId === auth.uid",
                    "status": {
                        ".validate": "newData.isString() && (newData.val() === 'online' || newData.val() === 'offline' || newData.val() === 'away' || newData.val() === 'inCall')"
                    },
                    "lastSeen": {
                        ".validate": "newData.isNumber()"
                    },
                    "$other": {
                        ".validate": false
                    }
                }
            },
            "calls": {
                ".indexOn": [
                    "status",
                    "createdAt"
                ],
                "$callId": {
                    ".read": "auth != null && (data.child('callerId').val() === auth.uid || data.child('receiverId').val() === auth.uid)",
                    ".write": "auth != null && (!data.exists() && newData.child('callerId').val() === auth.uid) || (data.exists() && (data.child('callerId').val() === auth.uid || data.child('receiverId').val() === auth.uid))",
                    ".validate": "newData.hasChildren(['id', 'callerId', 'receiverId', 'status'])",
                    "id": {
                        ".validate": "newData.isString()"
                    },
                    "callerId": {
                        ".validate": "newData.isString() && (!data.exists() || data.val() === newData.val())"
                    },
                    "receiverId": {
                        ".validate": "newData.isString() && (!data.exists() || data.val() === newData.val())"
                    },
                    "status": {
                        ".validate": "newData.isString() && (newData.val() === 'ringing' || newData.val() === 'active' || newData.val() === 'ended' || newData.val() === 'missed')"
                    },
                    "type": {
                        ".validate": "newData.isString() && (newData.val() === 'audio' || newData.val() === 'video')"
                    },
                    "createdAt": {
                        ".validate": "newData.isNumber()"
                    },
                    "answeredAt": {
                        ".validate": "newData.isNumber()"
                    },
                    "endedAt": {
                        ".validate": "newData.isNumber()"
                    },
                    "$other": {
                        ".validate": false
                    }
                }
            },
            "callSignals": {
                "$callId": {
                    ".read": "auth != null && (root.child('calls/' + $callId + '/callerId').val() === auth.uid || root.child('calls/' + $callId + '/receiverId').val() === auth.uid)",
                    ".write": "auth != null && (root.child('calls/' + $callId + '/callerId').val() === auth.uid || root.child('calls/' + $callId + '/receiverId').val() === auth.uid)",
                    "$signalId": {
                        ".validate": "newData.hasChildren(['senderId', 'type'])",
                        "senderId": {
                            ".validate": "newData.isString() && newData.val() === auth.uid"
                        },
                        "type": {
                            ".validate": "newData.isString() && (newData.val() === 'offer' || newData.val() === 'answer' || newData.val() === 'ice-candidate')"
                        },
                        "data": {
                            ".validate": "newData.isString()"
                        }
                    }
                }
            },
            "notifications": {
                "$userId": {
                    ".read": "auth != null && $userId === auth.uid",
                    ".write": false,
                    "$notificationId": {
                        ".validate": "newData.hasChildren(['id', 'userId', 'type', 'message', 'createdAt'])"
                    }
                }
            },
            "fcmTokens": {
                "$userId": {
                    ".read": "auth != null && $userId === auth.uid",
                    "$tokenId": {
                        ".write": "auth != null && $userId === auth.uid",
                        ".validate": "newData.hasChildren(['token', 'createdAt'])",
                        "token": {
                            ".validate": "newData.isString()"
                        },
                        "createdAt": {
                            ".validate": "newData.isNumber()"
                        },
                        "lastUsed": {
                            ".validate": "newData.isNumber()"
                        }
                    }
                }
            }
        }
    }
}